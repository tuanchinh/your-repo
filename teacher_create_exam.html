<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>üìò H·ªá th·ªëng t·∫°o ƒë·ªÅ ki·ªÉm tra n√¢ng cao ‚Äì M∆∞·ª£n c√¢u</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
<style>
body{font-family:'Roboto',sans-serif;background:#f4f6f9;margin:0;padding:20px;}
h1{text-align:center;color:#2c3e50;}
.card{background:#fff;border-radius:8px;padding:20px;margin:15px auto;max-width:1000px;box-shadow:0 4px 8px rgba(0,0,0,0.1);}
label{display:block;margin:10px 0 5px;font-weight:bold;}
input, select{padding:8px;border:1px solid #ccc;border-radius:6px;}
input[type=number]{width:60px;}
.level-inputs{display:flex;gap:10px;margin-bottom:10px;}
.level-inputs input{width:80px;}
.btn-group{text-align:center;margin-top:20px;}
button{background:#3498db;color:white;border:none;padding:10px 18px;margin:5px;border-radius:6px;cursor:pointer;transition:0.3s;}
button:hover{background:#2980b9;}
.question{margin:5px 0;padding:5px;border-left:4px solid #3498db;background:#fefefe;position:relative;}
.question.truefalse{border-left-color:#27ae60;background:#f0fff0;}
.question.short{border-left-color:#8e44ad;background:#f8f0ff;}
.question.essay{border-left-color:#e67e22;background:#fff8f0;}
#container{margin-top:20px;padding:15px;background:#ecf0f1;border-radius:8px;border:1px solid #bdc3c7;}
.section-title{font-size:18px;font-weight:bold;margin-bottom:10px;color:#2c3e50;}
.code-label{font-weight:bold;color:#c0392b;margin-bottom:10px;font-size:16px;}
.points-container{margin:10px 0;padding:10px;background:#f0f8ff;border:1px solid #90caf9;border-radius:6px;}
.points-container input{width:60px;}
</style>
</head>
<body>

<h1>üìò H·ªá th·ªëng t·∫°o ƒë·ªÅ ki·ªÉm tra n√¢ng cao ‚Äì M∆∞·ª£n c√¢u</h1>

<div class="card">
<label>M√¥n h·ªçc:</label>
<select id="subjectSelect">
<option>To√°n</option>
<option>Ng·ªØ vƒÉn</option>
<option>Ti·∫øng Anh</option>
<option>L·ªãch s·ª≠</option>
<option>Tin h·ªçc</option>
</select>

<label>L·ªõp:</label>
<select id="gradeSelect">
<option>6</option><option>7</option><option>8</option><option>9</option>
</select>

<label>B√†i mu·ªën t·∫°o (v√≠ d·ª•: 1,3,5):</label>
<input type="text" id="lessonInput" placeholder="1,3,5">

<label>S·ªë ƒë·ªÅ c·∫ßn t·∫°o:</label>
<input type="number" id="numExamsInput" value="1" min="1">

<label>T·ªïng s·ªë c√¢u trong ƒë·ªÅ:</label>
<input type="number" id="totalQuestionsInput" value="19" min="1">

<div class="points-container">
<p><b>ƒêi·ªÉm theo lo·∫°i c√¢u v√† m·ª©c ƒë·ªô:</b></p>
<table>
<tr><td>MCQ:</td>
<td>Nh·∫≠n bi·∫øt <input type="number" id="scoreMcq_nhanbiet" value="0.5" step="0.1"></td>
<td>Th√¥ng hi·ªÉu <input type="number" id="scoreMcq_thonghieu" value="1" step="0.1"></td>
<td>V·∫≠n d·ª•ng <input type="number" id="scoreMcq_vandung" value="1.5" step="0.1"></td>
</tr>
<tr><td>True/False:</td>
<td>Nh·∫≠n bi·∫øt <input type="number" id="scoreTruefalse_nhanbiet" value="0.5" step="0.1"></td>
<td>Th√¥ng hi·ªÉu <input type="number" id="scoreTruefalse_thonghieu" value="1" step="0.1"></td>
<td>V·∫≠n d·ª•ng <input type="number" id="scoreTruefalse_vandung" value="1.5" step="0.1"></td>
</tr>
<tr><td>Short Answer:</td>
<td>Nh·∫≠n bi·∫øt <input type="number" id="scoreShort_nhanbiet" value="1" step="0.1"></td>
<td>Th√¥ng hi·ªÉu <input type="number" id="scoreShort_thonghieu" value="1.5" step="0.1"></td>
<td>V·∫≠n d·ª•ng <input type="number" id="scoreShort_vandung" value="2" step="0.1"></td>
</tr>
<tr><td>Essay:</td>
<td>Nh·∫≠n bi·∫øt <input type="number" id="scoreEssay_nhanbiet" value="2" step="0.1"></td>
<td>Th√¥ng hi·ªÉu <input type="number" id="scoreEssay_thonghieu" value="3" step="0.1"></td>
<td>V·∫≠n d·ª•ng <input type="number" id="scoreEssay_vandung" value="4" step="0.1"></td>
</tr>
</table>
</div>

<div id="questionNumbersContainer">
<p>Ch·ªçn s·ªë c√¢u cho m·ªói lo·∫°i c√¢u h·ªèi m·ªói b√†i theo m·ª©c ƒë·ªô:</p>
<label>MCQ m·ªói b√†i:</label>
<div class="level-inputs">
  <input type="number" id="numMcq_nhanbiet" value="2" min="0" placeholder="Nh·∫≠n bi·∫øt">
  <input type="number" id="numMcq_thonghieu" value="2" min="0" placeholder="Th√¥ng hi·ªÉu">
  <input type="number" id="numMcq_vandung" value="2" min="0" placeholder="V·∫≠n d·ª•ng">
</div>

<label>True/False m·ªói b√†i:</label>
<div class="level-inputs">
  <input type="number" id="numTruefalse_nhanbiet" value="1" min="0" placeholder="Nh·∫≠n bi·∫øt">
  <input type="number" id="numTruefalse_thonghieu" value="1" min="0" placeholder="Th√¥ng hi·ªÉu">
  <input type="number" id="numTruefalse_vandung" value="1" min="0" placeholder="V·∫≠n d·ª•ng">
</div>

<label>Short Answer m·ªói b√†i:</label>
<div class="level-inputs">
  <input type="number" id="numShort_nhanbiet" value="1" min="0" placeholder="Nh·∫≠n bi·∫øt">
  <input type="number" id="numShort_thonghieu" value="1" min="0" placeholder="Th√¥ng hi·ªÉu">
  <input type="number" id="numShort_vandung" value="1" min="0" placeholder="V·∫≠n d·ª•ng">
</div>

<label>Essay m·ªói b√†i:</label>
<div class="level-inputs">
  <input type="number" id="numEssay_nhanbiet" value="1" min="0" placeholder="Nh·∫≠n bi·∫øt">
  <input type="number" id="numEssay_thonghieu" value="1" min="0" placeholder="Th√¥ng hi·ªÉu">
  <input type="number" id="numEssay_vandung" value="1" min="0" placeholder="V·∫≠n d·ª•ng">
</div>
</div>

<div class="btn-group">
<button id="generateBtn">üöÄ T·∫°o ƒë·ªÅ</button>
<button id="loadJSONBtn">üìÇ Load JSON c√¢u h·ªèi</button>
<input type="file" id="jsonFileInput" style="display:none" accept=".json" multiple>
<button id="previewBtn">üëÄ Xem tr∆∞·ªõc</button>
<button id="exportWordBtn">üìÑ Xu·∫•t Word t·ª´ng ƒë·ªÅ</button>
<button id="exportPdfBtn">üìÑ Xu·∫•t PDF t·ª´ng ƒë·ªÅ</button>
<button id="exportJsonBtn">üíæ Xu·∫•t JSON t·ª´ng ƒë·ªÅ</button>
</div>

<div id="container"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/docx@7.5.0/build/index.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const { jsPDF } = window.jspdf;
const { Document, Packer, Paragraph, TextRun } = docx;
let questionsJSON = [];
let generatedExams = [];

function generateExamCode(){ return "DE-"+Math.floor(1000+Math.random()*9000);}
function capitalize(str){ return str.charAt(0).toUpperCase()+str.slice(1);}
function getScoreMap(){
  const types=["mcq","truefalse","short","essay"];
  const levels=["nhanbiet","thonghieu","vandung"];
  const map={};
  types.forEach(type=>{
    map[type]={};
    levels.forEach(level=>{
      const el=document.getElementById(`score${capitalize(type)}_${level}`);
      map[type][capitalize(level)] = parseFloat(el.value)||0;
    });
  });
  return map;
}

// ---------- Load JSON ----------
document.getElementById("loadJSONBtn").onclick = ()=>document.getElementById("jsonFileInput").click();
document.getElementById("jsonFileInput").onchange = e=>{
  const files=Array.from(e.target.files);
  files.forEach(file=>{
    const reader=new FileReader();
    reader.onload=function(ev){
      try{
        const data=JSON.parse(ev.target.result);
        if(!Array.isArray(data.questions)){ alert("File JSON kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng!"); return; }
        data.questions.forEach(q=>{
          if(q.type==="truefalse" && !q.options) q.options={A:"ƒê√∫ng",B:"Sai",C:"Kh√¥ng bi·∫øt",D:"Kh√¥ng √°p d·ª•ng"};
          if(!q.level) q.level="Nh·∫≠n bi·∫øt";
          if(!q.lesson) q.lesson="1";
          questionsJSON.push(q);
        });
        alert(`ƒê√£ load JSON: ${file.name}, t·ªïng c√¢u h·ªèi hi·ªán c√≥: ${questionsJSON.length}`);
      }catch(err){ alert("L·ªói ƒë·ªçc file JSON: "+err);}
    };
    reader.readAsText(file);
  });
};

// ---------- T·∫°o ƒë·ªÅ gi·ªØ th·ª© t·ª± 1->n ----------
document.getElementById("generateBtn").onclick = ()=>{
  const lessons=document.getElementById("lessonInput").value.split(",").map(n=>n.trim()).filter(n=>n!=="");
  const numExams=parseInt(document.getElementById("numExamsInput").value);
  const totalQuestions=parseInt(document.getElementById("totalQuestionsInput").value)||19;
  if(lessons.length===0){ alert("Nh·∫≠p √≠t nh·∫•t 1 b√†i!"); return; }
  if(questionsJSON.length===0){ alert("Ch∆∞a load JSON!"); return; }
  const scoreMap=getScoreMap();
  generatedExams=[];

  for(let e=0;e<numExams;e++){
    const examCode=generateExamCode();
    const exam={examCode,subject:document.getElementById("subjectSelect").value,grade:document.getElementById("gradeSelect").value,questions:[]};
    let allPicked=[];

    lessons.forEach(lesson=>{
      const types=["mcq","truefalse","short","essay"];
      types.forEach(type=>{
        const idPrefix="num"+type.charAt(0).toUpperCase()+type.slice(1);
        const nb=parseInt(document.getElementById(idPrefix+"_nhanbiet").value)||0;
        const th=parseInt(document.getElementById(idPrefix+"_thonghieu").value)||0;
        const vd=parseInt(document.getElementById(idPrefix+"_vandung").value)||0;
        const levels=["Nh·∫≠n bi·∫øt","Th√¥ng hi·ªÉu","V·∫≠n d·ª•ng"];
        const counts=[nb,th,vd];

        levels.forEach((level,idx)=>{
          let needed=counts[idx];
          let picked=[];
          let poolCurrent=questionsJSON.filter(q=>q.lesson===lesson && q.type===type && q.level===level);
          picked.push(...poolCurrent.slice(0,needed).map(q=>({...q,fromLesson:q.lesson})));
          needed -= picked.length;

          if(needed>0){
            let otherPool=questionsJSON.filter(q=>q.lesson!==lesson && q.type===type && q.level===level);
            picked.push(...otherPool.slice(0,needed).map(q=>({...q,fromLesson:q.lesson})));
            needed -= otherPool.length;
          }
          if(needed>0) alert(`‚ö† Kh√¥ng ƒë·ªß c√¢u cho ${type.toUpperCase()} m·ª©c ${level} (l·∫•y ${counts[idx]-needed}/${counts[idx]})`);

          picked.forEach(q=>{ if(allPicked.length<totalQuestions) allPicked.push(q); });
        });
      });
    });

    exam.questions=allPicked; // Gi·ªØ nguy√™n th·ª© t·ª±
    generatedExams.push(exam);
  }
  alert(`ƒê√£ t·∫°o ${numExams} ƒë·ªÅ, m·ªói ƒë·ªÅ t·ªëi ƒëa ${totalQuestions} c√¢u!`);
};

// ---------- Xem tr∆∞·ªõc ----------
document.getElementById("previewBtn").onclick = ()=>{
  container.innerHTML="";
  generatedExams.forEach(exam=>{
    const codeDiv=document.createElement("div");
    codeDiv.className="code-label";
    codeDiv.textContent=`M√£ ƒë·ªÅ: ${exam.examCode}`;
    container.appendChild(codeDiv);
    const div=document.createElement("div");
    div.innerHTML=`<div class="section-title">${exam.subject} ‚Äì L·ªõp ${exam.grade}</div>`;
    let cnt=1;
    const scoreMap=getScoreMap();
    exam.questions.forEach(q=>{
      const qd=document.createElement("div");
      qd.className="question "+q.type;
      const fromText=(q.fromLesson && q.fromLesson!==q.lesson)?` (m∆∞·ª£n t·ª´ b√†i ${q.fromLesson})`:"";
      const score=scoreMap[q.type][q.level]||0;
      if(q.type==="mcq"||q.type==="truefalse")
        qd.innerHTML=`<b>${cnt}. ${q.content} (${q.level}) ‚Äì ${score} ƒëi·ªÉm${fromText}</b><br>A. ${q.options.A}<br>B. ${q.options.B}<br>C. ${q.options.C}<br>D. ${q.options.D}`;
      else if(q.type==="short")
        qd.innerHTML=`<b>${cnt}. ${q.content} (${q.level}) ‚Äì ${score} ƒëi·ªÉm${fromText}</b> (Tr·∫£ l·ªùi ng·∫Øn)`;
      else
        qd.innerHTML=`<b>${cnt}. ${q.content} (${q.level}) ‚Äì ${score} ƒëi·ªÉm${fromText}</b><br><i>(H·ªçc sinh t·ª± l√†m)</i>`;
      div.appendChild(qd);
      cnt++;
    });
    container.appendChild(div);
  });
};

// ---------- Xu·∫•t Word ----------
document.getElementById("exportWordBtn").onclick = async ()=>{
  const scoreMap=getScoreMap();
  for(const exam of generatedExams){
    const paragraphs=[];
    paragraphs.push(new Paragraph({children:[new TextRun({text:`M√É ƒê·ªÄ: ${exam.examCode}`,bold:true,color:"red",size:28*2})]}));
    paragraphs.push(new Paragraph({children:[new TextRun({text:`${exam.subject} ‚Äì L·ªõp ${exam.grade}`,bold:true,size:26*2})]}));
    const totalScore=exam.questions.reduce((sum,q)=>sum+(scoreMap[q.type][q.level]||0),0);
    paragraphs.push(new Paragraph({children:[new TextRun({text:`T·ªïng s·ªë c√¢u: ${exam.questions.length} ‚Äì T·ªïng ƒëi·ªÉm: ${totalScore}`,bold:true})]}));

    exam.questions.forEach((q,idx)=>{
      const score=scoreMap[q.type][q.level]||0;
      const fromText=(q.fromLesson && q.fromLesson!==q.lesson)?` (m∆∞·ª£n t·ª´ b√†i ${q.fromLesson})`:"";
      paragraphs.push(new Paragraph({children:[new TextRun({text:`${idx+1}. ${q.content} (${q.level}) ‚Äì ${score} ƒëi·ªÉm${fromText}`,bold:true})]}));
      if(q.type==="mcq"||q.type==="truefalse"){
        Object.entries(q.options).forEach(([k,v])=>paragraphs.push(new Paragraph({children:[new TextRun({text:`${k}. ${v}`})]})));
      } else for(let i=0;i<5;i++) paragraphs.push(new Paragraph({children:[new TextRun({text:"...................................................................................."})]}));
    });

    const doc=new Document({sections:[{children:paragraphs}]});
    const blob=await Packer.toBlob(doc);
    saveAs(blob,`De_${exam.examCode}.docx`);
  }
  alert("‚úÖ Xu·∫•t Word th√†nh c√¥ng!");
};

// ---------- Xu·∫•t PDF ----------
document.getElementById("exportPdfBtn").onclick=()=>{
  const scoreMap=getScoreMap();
  generatedExams.forEach(exam=>{
    const pdf=new jsPDF();
    pdf.setFontSize(12);
    pdf.text(`M√É ƒê·ªÄ: ${exam.examCode}`,10,10);
    pdf.text(`${exam.subject} ‚Äì L·ªõp ${exam.grade}`,10,18);
    const totalScore=exam.questions.reduce((sum,q)=>sum+(scoreMap[q.type][q.level]||0),0);
    pdf.text(`T·ªïng s·ªë c√¢u: ${exam.questions.length} ‚Äì T·ªïng ƒëi·ªÉm: ${totalScore}`,10,26);

    let y=34;
    exam.questions.forEach((q,idx)=>{
      const score=scoreMap[q.type][q.level]||0;
      const fromText=(q.fromLesson && q.fromLesson!==q.lesson)?` (m∆∞·ª£n t·ª´ b√†i ${q.fromLesson})`:"";
      pdf.text(`${idx+1}. ${q.content} (${q.level}) ‚Äì ${score} ƒëi·ªÉm${fromText}`,10,y);
      y+=6;
      if(q.type==="mcq"||q.type==="truefalse") Object.entries(q.options).forEach(([k,v])=>{pdf.text(`${k}. ${v}`,12,y);y+=6;});
      else for(let i=0;i<5;i++){pdf.text("........................................................................",12,y);y+=6;}
      if(y>270){pdf.addPage();y=10;}
    });
    pdf.save(`De_${exam.examCode}.pdf`);
  });
  alert("‚úÖ Xu·∫•t PDF th√†nh c√¥ng!");
};

// ---------- Xu·∫•t JSON ----------
document.getElementById("exportJsonBtn").onclick=()=>{
  generatedExams.forEach(exam=>{
    const blob=new Blob([JSON.stringify(exam,null,2)],{type:"application/json"});
    saveAs(blob,`De_${exam.examCode}.json`);
  });
  alert("‚úÖ Xu·∫•t JSON th√†nh c√¥ng!");
};
</script>

</body>
</html>
